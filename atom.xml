<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://waltcow.github.io</id>
    <title>waltcow</title>
    <updated>2021-07-27T09:44:44.603Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://waltcow.github.io"/>
    <link rel="self" href="https://waltcow.github.io/atom.xml"/>
    <subtitle>Do have faith in what you&apos;re doing.</subtitle>
    <logo>https://waltcow.github.io/images/avatar.png</logo>
    <icon>https://waltcow.github.io/favicon.ico</icon>
    <rights>All rights reserved 2021, waltcow</rights>
    <entry>
        <title type="html"><![CDATA[Kotlin Coroutine Part 3. Composing suspending functions]]></title>
        <id>https://waltcow.github.io/post/kotlin-coroutine-part-3-composing-suspending-functions/</id>
        <link href="https://waltcow.github.io/post/kotlin-coroutine-part-3-composing-suspending-functions/">
        </link>
        <updated>2021-07-27T09:42:50.000Z</updated>
        <summary type="html"><![CDATA[<p>è¿™ä¸€èŠ‚å°†ä»‹ç»å„ç§æ„å»ºsuspendå‡½æ•°çš„æ–¹æ³•</p>
]]></summary>
        <content type="html"><![CDATA[<p>è¿™ä¸€èŠ‚å°†ä»‹ç»å„ç§æ„å»ºsuspendå‡½æ•°çš„æ–¹æ³•</p>
<!-- more -->
<h2 id="é»˜è®¤çš„ä¸²è¡Œæ‰§è¡Œ">é»˜è®¤çš„ä¸²è¡Œæ‰§è¡Œ</h2>
<p>å‡è®¾æˆ‘ä»¬é¢„å…ˆå®šä¹‰äº†ä¸¤ä¸ªsuspendå‡½æ•°ï¼Œå®ƒä»¬è¿è¡Œç€ä¸€äº›æ¯”å¦‚è¿œç¨‹æœåŠ¡è°ƒç”¨æˆ–è®¡ç®—çš„é€»è¾‘ã€‚æˆ‘ä»¬åªæ˜¯å‡è£…å®ƒä»¬æ˜¯æœ‰ç”¨çš„ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ¯ä¸ªå‡½æ•°åªæ˜¯å»¶è¿Ÿä¸€ç§’é’Ÿä½œä¸ºæ¨¡æ‹Ÿã€‚</p>
<pre><code class="language-kotlin">suspend fun doSomethingUsefulOne(): Int {
    delay(1000L) // pretend we are doing something useful here
    return 13
}

suspend fun doSomethingUsefulTwo(): Int {
    delay(1000L) // pretend we are doing something useful here, too
    return 29
}
</code></pre>
<p>å¦‚æœæˆ‘ä»¬éœ€è¦å®ƒä»¬è¢«ä¾æ¬¡è°ƒç”¨ -- é¦–å…ˆæ˜¯<code>doSomethingUsefulOne</code>ï¼Œç„¶åæ˜¯<code>doSomethingUsefulTwo</code>ï¼Œå¹¶è®¡ç®—å®ƒä»¬çš„ç»“æœä¹‹å’Œï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆåšï¼Ÿåœ¨å®è·µä¸­ï¼Œå¦‚æœæˆ‘ä»¬ç”¨ç¬¬ä¸€ä¸ªå‡½æ•°çš„ç»“æœæ¥å†³å®šæ˜¯å¦éœ€è¦è°ƒç”¨ç¬¬äºŒä¸ªå‡½æ•°æˆ–å†³å®šå¦‚ä½•è°ƒç”¨ï¼Œæˆ‘ä»¬å°±ä¼šè¿™æ ·åšã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨æ­£å¸¸çš„é¡ºåºè°ƒç”¨ï¼Œå› ä¸ºcoroutineä¸­çš„ä»£ç ï¼Œå°±åƒæ™®é€šä»£ç ä¸€æ ·ï¼Œé»˜è®¤æ˜¯é¡ºåºæ‰§è¡Œçš„ã€‚ä¸‹é¢çš„ä¾‹å­é€šè¿‡æµ‹é‡ä¸¤ä¸ªsuspendå‡½æ•°çš„æ€»æ‰§è¡Œæ—¶é—´ä½œä¸ºæ¼”ç¤ºã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*
import kotlin.system.*

fun main() = runBlocking&lt;Unit&gt; {
//sampleStart
    val time = measureTimeMillis {
        val one = doSomethingUsefulOne()
        val two = doSomethingUsefulTwo()
        println(&quot;The answer is ${one + two}&quot;)
    }
    println(&quot;Completed in $time ms&quot;)
//sampleEnd    
}

suspend fun doSomethingUsefulOne(): Int {
    delay(1000L) // pretend we are doing something useful here
    return 13
}

suspend fun doSomethingUsefulTwo(): Int {
    delay(1000L) // pretend we are doing something useful here, too
    return 29
}
</code></pre>
<p>è¿è¡Œçš„è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre><code class="language-text">The answer is 42
Completed in 2017 ms
</code></pre>
<h2 id="ä½¿ç”¨asyncè¿›è¡Œå¹¶å‘">ä½¿ç”¨asyncè¿›è¡Œå¹¶å‘</h2>
<p>å¦‚æœ<code>doSomethingUsefulOne</code>å’Œ<code>doSomethingUsefulTwo</code>çš„è°ƒç”¨ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œè€Œæˆ‘ä»¬æƒ³åŒæ—¶è¿›è¡Œè¿™ä¸¤ä¸ªæ“ä½œæ¥æ›´å¿«åœ°å¾—åˆ°ç­”æ¡ˆï¼Œæ€ä¹ˆåŠï¼Ÿè¿™å°±æ˜¯<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/async.html">async</a>å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚</p>
<p>ä»æ¦‚å¿µä¸Šè®²ï¼Œ<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/async.html">async</a>å°±åƒ<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/launch.html">launch</a>ä¸€æ ·ã€‚å®ƒå¯åŠ¨äº†ä¸€ä¸ªå•ç‹¬çš„coroutineï¼Œè¿™æ˜¯ä¸€ä¸ªè½»é‡çº§çš„çº¿ç¨‹ï¼Œä¸æ‰€æœ‰å…¶ä»–çš„coroutineåŒæ—¶å·¥ä½œã€‚ä¸åŒçš„æ˜¯ï¼Œ<code>launch</code>è¿”å›ä¸€ä¸ª<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-job/index.html">Job</a>ï¼Œå¹¶ä¸”ä¸æºå¸¦ä»»ä½•ç»“æœå€¼ï¼Œè€Œ<code>async</code>è¿”å›ä¸€ä¸ª<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-deferred/index.html">Deferred</a>--ä¸€ä¸ªè½»é‡çº§çš„éé˜»å¡æœªæ¥ï¼Œä»£è¡¨ä¸€ä¸ªæ‰¿è¯ºï¼Œä»¥åæä¾›ä¸€ä¸ªç»“æœã€‚ä½ å¯ä»¥åœ¨ä¸€ä¸ªå»¶è¿Ÿå€¼ä¸Šä½¿ç”¨<code>.await()</code>æ¥è·å¾—å®ƒçš„æœ€ç»ˆç»“æœï¼Œä½†æ˜¯<code>Deferred</code>ä¹Ÿæ˜¯ä¸€ä¸ª<code>Job</code>ï¼Œæ‰€ä»¥ä½ å¯ä»¥åœ¨éœ€è¦æ—¶å–æ¶ˆå®ƒã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*
import kotlin.system.*

fun main() = runBlocking&lt;Unit&gt; {
//sampleStart
    val time = measureTimeMillis {
        val one = async { doSomethingUsefulOne() }
        val two = async { doSomethingUsefulTwo() }
        println(&quot;The answer is ${one.await() + two.await()}&quot;)
    }
    println(&quot;Completed in $time ms&quot;)
//sampleEnd    
}

suspend fun doSomethingUsefulOne(): Int {
    delay(1000L) // pretend we are doing something useful here
    return 13
}

suspend fun doSomethingUsefulTwo(): Int {
    delay(1000L) // pretend we are doing something useful here, too
    return 29
}

</code></pre>
<p>è¿è¡Œçš„è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre><code class="language-text">The answer is 42
Completed in 1017 ms

</code></pre>
<p>è¿™æ˜¯ä¸¤å€çš„é€Ÿåº¦ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªcoroutinesæ˜¯åŒæ—¶æ‰§è¡Œçš„ã€‚è¯·æ³¨æ„ï¼Œcoroutinesçš„å¹¶å‘æ€§æ€»æ˜¯æ˜¾å¼çš„ã€‚</p>
<h2 id="æ‡’å¯åŠ¨çš„å¼‚æ­¥">æ‡’å¯åŠ¨çš„å¼‚æ­¥</h2>
<p>å¦å¤–ï¼Œ<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/async.html">async</a>å¯ä»¥é€šè¿‡å°†å…¶<code>start</code>å‚æ•°è®¾ç½®ä¸º<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-start/-l-a-z-y/index.html">CoroutineStart.LAZY</a>è€Œå˜æˆæ‡’å¯åŠ¨ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œåªæœ‰å½“<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-deferred/await.html">await</a>éœ€è¦å®ƒçš„ç»“æœæ—¶ï¼Œæˆ–è€…å®ƒçš„`Job'çš„<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-job/start.html">start</a>å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå®ƒæ‰ä¼šå¯åŠ¨coroutineã€‚è¿è¡Œä¸‹é¢çš„ä¾‹å­ã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*
import kotlin.system.*

fun main() = runBlocking&lt;Unit&gt; {
//sampleStart
    val time = measureTimeMillis {
        val one = async(start = CoroutineStart.LAZY) { doSomethingUsefulOne() }
        val two = async(start = CoroutineStart.LAZY) { doSomethingUsefulTwo() }
        // some computation
        one.start() // start the first one
        two.start() // start the second one
        println(&quot;The answer is ${one.await() + two.await()}&quot;)
    }
    println(&quot;Completed in $time ms&quot;)
//sampleEnd    
}

suspend fun doSomethingUsefulOne(): Int {
    delay(1000L) // pretend we are doing something useful here
    return 13
}

suspend fun doSomethingUsefulTwo(): Int {
    delay(1000L) // pretend we are doing something useful here, too
    return 29
}
</code></pre>
<p>è¿è¡Œçš„è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre><code class="language-text">The answer is 42
Completed in 1017 ms
</code></pre>
<p>æ‰€ä»¥ï¼Œè¿™é‡Œå®šä¹‰äº†ä¸¤ä¸ªcoroutinesï¼Œä½†æ²¡æœ‰åƒå‰é¢çš„ä¾‹å­é‚£æ ·æ‰§è¡Œï¼Œè€Œæ˜¯é€šè¿‡è°ƒç”¨<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-job/start.html">start</a>ï¼Œå°†å…·ä½“ä½•æ—¶å¼€å§‹æ‰§è¡Œçš„æ§åˆ¶æƒäº¤ç»™ç¨‹åºå‘˜ã€‚æˆ‘ä»¬é¦–å…ˆå¯åŠ¨ &quot;one&quot;ï¼Œç„¶åå¯åŠ¨ &quot;two&quot;ï¼Œç„¶åç­‰å¾…å„ä¸ªcoroutinesçš„å®Œæˆã€‚</p>
<p>è¯·æ³¨æ„ï¼Œå¦‚æœæˆ‘ä»¬åªæ˜¯åœ¨<code>println</code>ä¸­è°ƒç”¨<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-deferred/await.html">await</a>ï¼Œè€Œä¸å…ˆåœ¨å•ä¸ªcoroutineä¸Šè°ƒç”¨<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-job/start.html">start</a>ï¼Œè¿™å°†å¯¼è‡´é¡ºåºæ‰§è¡Œçš„ï¼Œå› ä¸º<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-deferred/await.html">await</a>å¯åŠ¨coroutineæ‰§è¡Œå¹¶ç­‰å¾…å…¶ç»“æŸï¼Œè¿™ä¸æ˜¯æ‡’å¯åŠ¨çš„é¢„æœŸè¡Œä¸ºã€‚<code>async(start = CoroutineStart.LAZY)</code>çš„ç”¨ä¾‹æ˜¯åœ¨è®¡ç®—å€¼æ¶‰åŠæš‚åœåŠŸèƒ½çš„æƒ…å†µä¸‹æ›¿ä»£æ ‡å‡†<code>lazy</code>å‡½æ•°ã€‚</p>
<h2 id="å¼‚æ­¥é£æ ¼çš„å‡½æ•°">å¼‚æ­¥é£æ ¼çš„å‡½æ•°</h2>
<p>æˆ‘ä»¬å¯ä»¥å®šä¹‰å¼‚æ­¥é£æ ¼çš„å‡½æ•°ï¼Œä½¿ç”¨<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/async.html">async</a> coroutineæ„å»ºå™¨æ¥å¼‚æ­¥è°ƒç”¨<code>doSomethingUsefulOne</code>å’Œ<code>doSomethingUsefulTwo</code>ï¼Œä½¿ç”¨<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-global-scope/index.html">GlobalScope</a>å¼•ç”¨æ¥é€‰æ‹©é€€å‡ºç»“æ„åŒ–å¹¶å‘ã€‚æˆ‘ä»¬ç”¨&quot;......Async &quot;åç¼€æ¥å‘½åè¿™ç±»å‡½æ•°ï¼Œä»¥å¼ºè°ƒå®ƒä»¬ä½¿ç”¨å¼‚æ­¥è®¡ç®—ï¼Œäººä»¬éœ€è¦ä½¿ç”¨è¿”å›çš„å»¶è¿Ÿå€¼æ¥è·å–ç»“æœã€‚</p>
<blockquote>
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-global-scope/index.html">GlobalScope</a>æ˜¯ä¸€ä¸ªç²¾è‡´çš„APIï¼Œå…¶ä¸­ä¹‹ä¸€å°†åœ¨ä¸‹é¢è§£é‡Šï¼Œæ‰€ä»¥ä½ å¿…é¡»æ˜ç¡®åœ°é€‰æ‹©ä½¿ç”¨<code>GlobalScope</code>ä¸<code>@OptIn(DelicateCoroutinesApi::class)</code></p>
</blockquote>
<pre><code class="language-kotlin">// The result type of somethingUsefulOneAsync is Deferred&lt;Int&gt;
@OptIn(DelicateCoroutinesApi::class)
fun somethingUsefulOneAsync() = GlobalScope.async {
    doSomethingUsefulOne()
}

// The result type of somethingUsefulTwoAsync is Deferred&lt;Int&gt;
@OptIn(DelicateCoroutinesApi::class)
fun somethingUsefulTwoAsync() = GlobalScope.async {
    doSomethingUsefulTwo()
}
</code></pre>
<p>è¯·æ³¨æ„ï¼Œè¿™äº›<code>xxxAsync</code>å‡½æ•°ä¸æ˜¯<em>suspending</em>å‡½æ•°ã€‚å®ƒä»¬å¯ä»¥ä»ä»»ä½•åœ°æ–¹ä½¿ç”¨ã€‚ç„¶è€Œï¼Œä½¿ç”¨å®ƒä»¬æ„å‘³ç€æ˜¯å¼‚æ­¥<em>å¹¶å‘</em> æ‰§è¡Œã€‚</p>
<p>ä¸‹é¢çš„ä¾‹å­ä»‹ç»å®ƒä»¬åœ¨coroutineä¹‹å¤–çš„ä½¿ç”¨ã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*
import kotlin.system.*

//sampleStart
// note that we don't have `runBlocking` to the right of `main` in this example
fun main() {
    val time = measureTimeMillis {
        // we can initiate async actions outside of a coroutine
        val one = somethingUsefulOneAsync()
        val two = somethingUsefulTwoAsync()
        // but waiting for a result must involve either suspending or blocking.
        // here we use `runBlocking { ... }` to block the main thread while waiting for the result
        runBlocking {
            println(&quot;The answer is ${one.await() + two.await()}&quot;)
        }
    }
    println(&quot;Completed in $time ms&quot;)
}
//sampleEnd

@OptIn(DelicateCoroutinesApi::class)
fun somethingUsefulOneAsync() = GlobalScope.async {
    doSomethingUsefulOne()
}

@OptIn(DelicateCoroutinesApi::class)
fun somethingUsefulTwoAsync() = GlobalScope.async {
    doSomethingUsefulTwo()
}

suspend fun doSomethingUsefulOne(): Int {
    delay(1000L) // pretend we are doing something useful here
    return 13
}

suspend fun doSomethingUsefulTwo(): Int {
    delay(1000L) // pretend we are doing something useful here, too
    return 29
}
</code></pre>
<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code>The answer is 42
Completed in 1175 ms
</code></pre>
<blockquote>
<p>è¿™ç§å¸¦æœ‰å¼‚æ­¥å‡½æ•°çš„ç¼–ç¨‹é£æ ¼åœ¨è¿™é‡Œåªæ˜¯ä¸ºäº†è¯´æ˜é—®é¢˜ï¼Œå› ä¸ºå®ƒåœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­æ˜¯ä¸€ç§æµè¡Œçš„é£æ ¼ã€‚åœ¨Kotlin coroutinesä¸­ä½¿ç”¨è¿™ç§é£æ ¼æ˜¯<strong>å¼ºçƒˆåå¯¹</strong>çš„ï¼ŒåŸå› å¦‚ä¸‹</p>
</blockquote>
<p>è€ƒè™‘ä¸€ä¸‹ï¼Œå¦‚æœåœ¨<code>val one = somethingUsefulOneAsync()</code> å’Œ <code>one.await()</code>è¡¨è¾¾å¼ä¹‹é—´ï¼Œä»£ç ä¸­å‡ºç°äº†ä¸€äº›é€»è¾‘é”™è¯¯ï¼Œç¨‹åºæŠ›å‡ºäº†ä¸€ä¸ªå¼‚å¸¸ï¼Œç¨‹åºæ­£åœ¨è¿›è¡Œçš„æ“ä½œå°±ä¼šä¸­æ­¢ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå…¨å±€é”™è¯¯å¤„ç†ç¨‹åºå¯ä»¥æ•è·è¿™ä¸ªå¼‚å¸¸ï¼Œä¸ºå¼€å‘è€…è®°å½•å’ŒæŠ¥å‘Šè¿™ä¸ªé”™è¯¯ï¼Œä½†ç¨‹åºå¯ä»¥ç»§ç»­è¿›è¡Œå…¶ä»–æ“ä½œã€‚ç„¶è€Œï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°<code>somethingUsefulOneAsync</code>ä»ç„¶åœ¨åå°è¿è¡Œï¼Œå°½ç®¡å¯åŠ¨å®ƒçš„æ“ä½œè¢«ä¸­æ­¢äº†ã€‚è¿™ä¸ªé—®é¢˜åœ¨ç»“æ„åŒ–å¹¶å‘ä¸­ä¸ä¼šå‘ç”Ÿï¼Œå¦‚ä¸‹èŠ‚æ‰€ç¤ºã€‚</p>
<h2 id="ä½¿ç”¨asyncè¿›è¡Œ-ç»“æ„åŒ–å¹¶å‘">ä½¿ç”¨asyncè¿›è¡Œ ç»“æ„åŒ–å¹¶å‘</h2>
<p>è®©æˆ‘ä»¬ä»¥<a href="#concurrent-using-async">Concurrent using async</a>ä¸ºä¾‹ï¼Œæå–ä¸€ä¸ªå‡½æ•°æ¥å¹¶å‘æ‰§è¡Œ<code>doSomethingUsefulOne</code>å’Œ<code>doSomethingUsefulTwo</code>å¹¶è¿”å›å…¶ç»“æœçš„æ€»å’Œã€‚å› ä¸º<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/async.html">async</a> coroutine builderè¢«å®šä¹‰ä¸º<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-scope/index.html">CoroutineScope</a>çš„æ‰©å±•ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä½œç”¨åŸŸä¸­æ‹¥æœ‰å®ƒï¼Œè¿™å°±æ˜¯<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/coroutine-scope.html">coroutineScope</a>å‡½æ•°æ‰€æä¾›çš„ã€‚</p>
<pre><code class="language-kotlin">suspend fun concurrentSum(): Int = coroutineScope {
    val one = async { doSomethingUsefulOne() }
    val two = async { doSomethingUsefulTwo() }
    one.await() + two.await()
}
</code></pre>
<p>è¿™æ ·ï¼Œå¦‚æœ &quot;concurrentSum &quot;å‡½æ•°çš„ä»£ç å‡ºäº†é—®é¢˜ï¼Œå®ƒæŠ›å‡ºäº†ä¸€ä¸ªå¼‚å¸¸ï¼Œæ‰€æœ‰åœ¨å…¶èŒƒå›´å†…å¯åŠ¨çš„ç¨‹åºéƒ½ä¼šè¢«å–æ¶ˆã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*
import kotlin.system.*

fun main() = runBlocking&lt;Unit&gt; {
//sampleStart
    val time = measureTimeMillis {
        println(&quot;The answer is ${concurrentSum()}&quot;)
    }
    println(&quot;Completed in $time ms&quot;)
//sampleEnd    
}

suspend fun concurrentSum(): Int = coroutineScope {
    val one = async { doSomethingUsefulOne() }
    val two = async { doSomethingUsefulTwo() }
    one.await() + two.await()
}

suspend fun doSomethingUsefulOne(): Int {
    delay(1000L) // pretend we are doing something useful here
    return 13
}

suspend fun doSomethingUsefulTwo(): Int {
    delay(1000L) // pretend we are doing something useful here, too
    return 29
}
</code></pre>
<p>ä»ä¸Šè¿°`main'å‡½æ•°çš„è¾“å‡ºä¸­å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬ä»ç„¶æœ‰ä¸¤ä¸ªæ“ä½œçš„å¹¶å‘æ‰§è¡Œã€‚</p>
<pre><code class="language-text">The answer is 42
Completed in 1017 ms
</code></pre>
<p>å–æ¶ˆæ€»æ˜¯é€šè¿‡coroutinesçš„å±‚æ¬¡ç»“æ„ä¼ æ’­ã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*

fun main() = runBlocking&lt;Unit&gt; {
    try {
        failedConcurrentSum()
    } catch(e: ArithmeticException) {
        println(&quot;Computation failed with ArithmeticException&quot;)
    }
}

suspend fun failedConcurrentSum(): Int = coroutineScope {
    val one = async&lt;Int&gt; { 
        try {
            delay(Long.MAX_VALUE) // Emulates very long computation
            42
        } finally {
            println(&quot;First child was cancelled&quot;)
        }
    }
    val two = async&lt;Int&gt; { 
        println(&quot;Second child throws an exception&quot;)
        throw ArithmeticException()
    }
    one.await() + two.await()
}

</code></pre>
<p>è¯·æ³¨æ„ç¬¬ä¸€ä¸ª<code>async</code> å’Œç­‰å¾…ä¸­çš„çˆ¶ç±»æ˜¯å¦‚ä½•åœ¨å…¶ä¸­ä¸€ä¸ªå­ç±»ï¼ˆå³<code>two</code>ï¼‰å¤±è´¥æ—¶è¢«å–æ¶ˆçš„ã€‚</p>
<pre><code class="language-text">Second child throws an exception
First child was cancelled
Computation failed with ArithmeticException
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kotlin Coroutine Part 2. Cancellation and timeouts]]></title>
        <id>https://waltcow.github.io/post/kotlin-coroutine-part-2-cancellation-and-timeouts/</id>
        <link href="https://waltcow.github.io/post/kotlin-coroutine-part-2-cancellation-and-timeouts/">
        </link>
        <updated>2021-07-27T08:32:32.000Z</updated>
        <summary type="html"><![CDATA[<p>æœ¬æ–‡ç®€å•ä»‹ç»ä¸€ä¸‹ Kotlin Coroutineçš„å–æ¶ˆå’Œè¶…æ—¶å¤„ç†</p>
]]></summary>
        <content type="html"><![CDATA[<p>æœ¬æ–‡ç®€å•ä»‹ç»ä¸€ä¸‹ Kotlin Coroutineçš„å–æ¶ˆå’Œè¶…æ—¶å¤„ç†</p>
<!-- more -->
<p>åœ¨ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„åº”ç”¨ç¨‹åºä¸­ï¼Œä½ å¯èƒ½éœ€è¦å¯¹ä½ çš„åå°çš„coroutinesè¿›è¡Œç»†ç²’åº¦çš„æ§åˆ¶ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·å¯èƒ½å·²ç»å…³é—­äº†ä¸€ä¸ªcoroutineæ­£åœ¨è¿è¡Œç€çš„é¡µé¢ï¼Œç°åœ¨ä¸å†éœ€è¦å…¶ç»“æœï¼Œå¯ä»¥å–æ¶ˆå…¶æ“ä½œã€‚<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/launch.html">launch</a>å‡½æ•°è¿”å›ä¸€ä¸ª<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-job/index.html">Job</a>ï¼Œå¯ä»¥ç”¨æ¥å–æ¶ˆæ­£åœ¨è¿è¡Œçš„coroutineã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*

fun main() = runBlocking {
//sampleStart
    val job = launch {
        repeat(1000) { i -&gt;
            println(&quot;job: I'm sleeping $i ...&quot;)
            delay(500L)
        }
    }
    delay(1300L) // delay a bit
    println(&quot;main: I'm tired of waiting!&quot;)
    job.cancel() // cancels the job
    job.join() // waits for job's completion 
    println(&quot;main: Now I can quit.&quot;)
//sampleEnd    
}
</code></pre>
<p>å®ƒçš„è¾“å‡ºç»“æœå¦‚ä¸‹</p>
<pre><code class="language-text">job: I'm sleeping 0 ...
job: I'm sleeping 1 ...
job: I'm sleeping 2 ...
main: I'm tired of waiting!
main: Now I can quit.
</code></pre>
<p>åªè¦mainè°ƒç”¨<code>job.cancel</code>ï¼Œæˆ‘ä»¬å°±çœ‹ä¸åˆ°å¦ä¸€ä¸ªcoroutineçš„ä»»ä½•è¾“å‡ºï¼Œå› ä¸ºå®ƒè¢«å–æ¶ˆäº†ã€‚è¿˜æœ‰ä¸€ä¸ª<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-job/index.html">Job</a>çš„æ‰©å±•å‡½æ•°<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/cancel-and-join.html">cancelAndJoin</a>ï¼Œç»“åˆäº†<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/cancel.html">cancel</a>å’Œ<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-job/join.html">join</a>çš„è°ƒç”¨ã€‚</p>
<h2 id="å–æ¶ˆæ˜¯ç›¸äº’ååŒçš„">å–æ¶ˆæ˜¯ç›¸äº’ååŒçš„</h2>
<p>Coroutineçš„å–æ¶ˆæ˜¯<em>ç›¸äº’ååŒçš„</em>ã€‚Coroutineä»£ç å¿…é¡»åœ¨ç›¸äº’ååŒä¸‹æ‰èƒ½è¢«å–æ¶ˆã€‚<code>kotlinx.coroutines</code>ä¸­æ‰€æœ‰çš„suspendå‡½æ•°éƒ½æ˜¯<em>å¯å–æ¶ˆçš„</em>ã€‚å®ƒä»¬ä¼šæ£€æŸ¥Coroutineç¨‹åºçš„å–æ¶ˆï¼Œå¹¶åœ¨å–æ¶ˆæ—¶æŠ›å‡º<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-cancellation-exception/index.html">CancellationException</a>ã€‚ç„¶è€Œï¼Œå¦‚æœä¸€ä¸ªCoroutineåœ¨è®¡ç®—å·¥ä½œä¸­ï¼Œå¹¶ä¸”æ²¡æœ‰æ£€æŸ¥å–æ¶ˆï¼Œé‚£ä¹ˆå®ƒå°±ä¸èƒ½è¢«å–æ¶ˆï¼Œå°±åƒä¸‹é¢çš„ä¾‹å­æ‰€ç¤ºã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*

fun main() = runBlocking {
//sampleStart
    val startTime = System.currentTimeMillis()
    val job = launch(Dispatchers.Default) {
        var nextPrintTime = startTime
        var i = 0
        while (i &lt; 5) { // computation loop, just wastes CPU
            // print a message twice a second
            if (System.currentTimeMillis() &gt;= nextPrintTime) {
                println(&quot;job: I'm sleeping ${i++} ...&quot;)
                nextPrintTime += 500L
            }
        }
    }
    delay(1300L) // delay a bit
    println(&quot;main: I'm tired of waiting!&quot;)
    job.cancelAndJoin() // cancels the job and waits for its completion
    println(&quot;main: Now I can quit.&quot;)
//sampleEnd    
}

</code></pre>
<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code>job: I'm sleeping 0 ...
job: I'm sleeping 1 ...
job: I'm sleeping 2 ...
main: I'm tired of waiting!
job: I'm sleeping 3 ...
job: I'm sleeping 4 ...
main: Now I can quit.

</code></pre>
<p>è¿è¡Œä¸Šé¢ç¨‹åºå¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿jobåœ¨å–æ¶ˆåï¼Œä»ç„¶ç»§ç»­æ‰“å° &quot;I'm sleeping&quot;ï¼Œç›´åˆ° jobåœ¨äº”æ¬¡åå¤åè‡ªè¡Œå®Œæˆã€‚</p>
<h2 id="è®©è®¡ç®—ä¸­ä»£ç å¯ä»¥å–æ¶ˆ">è®©è®¡ç®—ä¸­ä»£ç å¯ä»¥å–æ¶ˆ</h2>
<p>æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥ä½¿è®¡ç®—ä»£ç å¯å–æ¶ˆã€‚ç¬¬ä¸€ç§æ˜¯å‘¨æœŸæ€§åœ°è°ƒç”¨ä¸€ä¸ªæ£€æŸ¥å–æ¶ˆçš„æš‚åœå‡½æ•°ã€‚è­¬å¦‚ä½¿ç”¨ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/yield.html">yield</a>å‡½æ•°æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚å¦ä¸€ç§æ˜¯æ˜¾å¼åœ°æ£€æŸ¥å–æ¶ˆçš„çŠ¶æ€ã€‚è®©æˆ‘ä»¬è¯•è¯•åä¸€ç§æ–¹æ³•ã€‚</p>
<p>ç”¨<code>while (isActive)</code>æ›¿æ¢å‰é¢ä¾‹å­ä¸­çš„<code>while (i &lt; 5)</code>ï¼Œç„¶åé‡æ–°è¿è¡Œå®ƒã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*

fun main() = runBlocking {
//sampleStart
    val startTime = System.currentTimeMillis()
    val job = launch(Dispatchers.Default) {
        var nextPrintTime = startTime
        var i = 0
        while (isActive) { // cancellable computation loop
            // print a message twice a second
            if (System.currentTimeMillis() &gt;= nextPrintTime) {
                println(&quot;job: I'm sleeping ${i++} ...&quot;)
                nextPrintTime += 500L
            }
        }
    }
    delay(1300L) // delay a bit
    println(&quot;main: I'm tired of waiting!&quot;)
    job.cancelAndJoin() // cancels the job and waits for its completion
    println(&quot;main: Now I can quit.&quot;)
//sampleEnd    
}
</code></pre>
<p>è¿è¡Œç»“æœï¼š</p>
<pre><code>job: I'm sleeping 0 ...
job: I'm sleeping 1 ...
job: I'm sleeping 2 ...
main: I'm tired of waiting!
main: Now I can quit.
</code></pre>
<p>æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œç°åœ¨è¿™ä¸ªå¾ªç¯è¢«å–æ¶ˆäº†ã€‚<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/is-active.html">isActive</a>æ˜¯é€šè¿‡<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-scope/index.html">CoroutineScope</a>å¯¹è±¡åœ¨coroutineå†…éƒ¨å¯ç”¨çš„ä¸€ä¸ªæ‰©å±•å±æ€§ã€‚</p>
<h2 id="ç”¨-finallyå…³é—­å ç”¨èµ„æº">ç”¨ <code>finally</code>å…³é—­å ç”¨èµ„æº</h2>
<p>å¯å–æ¶ˆçš„æš‚åœå‡½æ•°åœ¨å–æ¶ˆæ—¶æŠ›å‡º<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-cancellation-exception/index.html">CancellationException</a>ï¼Œå¯ä»¥ç”¨å¸¸è§„æ–¹å¼å¤„ç†ã€‚ä¾‹å¦‚ï¼Œ<code>try {...} finally {...}</code>è¡¨è¾¾å¼å’Œä½¿ç”¨Kotlinçš„<code>use</code>å‡½æ•°ï¼Œåœ¨ä¸€ä¸ªcoroutineè¢«å–æ¶ˆæ—¶æ­£å¸¸æ‰§è¡Œå®ƒä»¬çš„æœ€ç»ˆå¤„ç†åŠ¨ä½œã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*

fun main() = runBlocking {
//sampleStart
    val job = launch {
        try {
            repeat(1000) { i -&gt;
                println(&quot;job: I'm sleeping $i ...&quot;)
                delay(500L)
            }
        } finally {
            println(&quot;job: I'm running finally&quot;)
        }
    }
    delay(1300L) // delay a bit
    println(&quot;main: I'm tired of waiting!&quot;)
    job.cancelAndJoin() // cancels the job and waits for its completion
    println(&quot;main: Now I can quit.&quot;)
//sampleEnd    
}

</code></pre>
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-job/join.html">join</a>å’Œ<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/cancel-and-join.html">cancelAndJoin</a>éƒ½ä¼šç­‰å¾…æ‰€æœ‰çš„ç»ˆç»“åŠ¨ä½œå®Œæˆï¼Œæ‰€ä»¥ä¸Šé¢çš„ä¾‹å­ä¼šäº§ç”Ÿä»¥ä¸‹è¾“å‡º</p>
<pre><code class="language-text">job: I'm sleeping 0 ...
job: I'm sleeping 1 ...
job: I'm sleeping 2 ...
main: I'm tired of waiting!
job: I'm running finally
main: Now I can quit.
</code></pre>
<h2 id="è¿è¡Œä¸å¯å–æ¶ˆçš„ç¨‹åºå—">è¿è¡Œä¸å¯å–æ¶ˆçš„ç¨‹åºå—</h2>
<p>åœ¨å‰é¢ä¾‹å­ä¸­ï¼Œä»»ä½•è¯•å›¾åœ¨ <code>finally</code>å—ä¸­ä½¿ç”¨suspendå‡½æ•°çš„è¡Œä¸ºéƒ½ä¼šå¯¼è‡´<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-cancellation-exception/index.html">CancellationException</a>ï¼Œå› ä¸ºè¿è¡Œè¿™æ®µä»£ç çš„coroutineè¢«å–æ¶ˆäº†ã€‚é€šå¸¸æƒ…å†µä¸‹è¿™ä¸æ˜¯é—®é¢˜ï¼Œå› ä¸ºæ‰€æœ‰è¡¨ç°è‰¯å¥½çš„å…³é—­æ“ä½œï¼ˆå…³é—­Fileã€å–æ¶ˆJobæˆ–å…³é—­ä»»ä½•ç±»å‹çš„channelï¼‰é€šå¸¸éƒ½æ˜¯æ— é˜»å¡çš„ï¼Œä¸æ¶‰åŠä»»ä½•æŒ‚èµ·å‡½æ•°ã€‚ç„¶è€Œï¼Œåœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼Œå½“ä½ éœ€è¦åœ¨ä¸€ä¸ªå·²å–æ¶ˆçš„ç¨‹åºä¸­æš‚åœæ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/with-context.html">withContext</a>å‡½æ•°å’Œ<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-non-cancellable/index.html">NonCancellable</a> çš„context å°†ç›¸åº”çš„ä»£ç åŒ…è£¹åœ¨<code>withContext(NonCancellable) {...}</code>ä¸­ï¼Œæ­£å¦‚ä¸‹é¢çš„ä¾‹å­æ‰€ç¤ºã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*

fun main() = runBlocking {
//sampleStart
    val job = launch {
        try {
            repeat(1000) { i -&gt;
                println(&quot;job: I'm sleeping $i ...&quot;)
                delay(500L)
            }
        } finally {
            withContext(NonCancellable) {
                println(&quot;job: I'm running finally&quot;)
                delay(1000L)
                println(&quot;job: And I've just delayed for 1 sec because I'm non-cancellable&quot;)
            }
        }
    }
    delay(1300L) // delay a bit
    println(&quot;main: I'm tired of waiting!&quot;)
    job.cancelAndJoin() // cancels the job and waits for its completion
    println(&quot;main: Now I can quit.&quot;)
//sampleEnd    
}
</code></pre>
<p>ä»£ç è¿è¡Œç»“æœ</p>
<pre><code>job: I'm sleeping 0 ...
job: I'm sleeping 1 ...
job: I'm sleeping 2 ...
main: I'm tired of waiting!
job: I'm running finally
job: And I've just delayed for 1 sec because I'm non-cancellable
main: Now I can quit.

</code></pre>
<h2 id="è¶…æ—¶å¤„ç†">è¶…æ—¶å¤„ç†</h2>
<p>å–æ¶ˆæ‰§è¡Œä¸€ä¸ªcoroutineçš„æœ€æ˜æ˜¾ä¸”å®é™…åŸå› æ˜¯å› ä¸ºå®ƒçš„æ‰§è¡Œæ—¶é—´å·²ç»è¶…æ—¶äº†ã€‚è™½ç„¶ä½ å¯ä»¥æ‰‹åŠ¨è·Ÿè¸ªç›¸åº”çš„<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-job/index.html">Job</a>çš„å¼•ç”¨ï¼Œå¹¶åœ¨å»¶è¿Ÿä¸€ä¼šå„¿åå†å¯åŠ¨ä¸€ä¸ªå•ç‹¬çš„coroutineæ¥å–æ¶ˆé‚£ä¸ªjobï¼Œè¿™é‡Œæ¨èä¸€ä¸ª<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/with-timeout.html">withTimeout</a>å‡½æ•°å¯ä»¥åšåˆ°è¿™ç‚¹ã€‚è¯·çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*

fun main() = runBlocking {
//sampleStart
    withTimeout(1300L) {
        repeat(1000) { i -&gt;
            println(&quot;I'm sleeping $i ...&quot;)
            delay(500L)
        }
    }
//sampleEnd
}
</code></pre>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹:</p>
<pre><code class="language-text">I'm sleeping 0 ...
I'm sleeping 1 ...
I'm sleeping 2 ...
Exception in thread &quot;main&quot; kotlinx.coroutines.TimeoutCancellationException: Timed out waiting for 1300 ms
</code></pre>
<p>ç”±<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/with-timeout.html">withTimeout</a>æŠ›å‡ºçš„<code>TimeoutCancellationException</code>æ˜¯<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-cancellation-exception/index.html">CancellationException</a>çš„ä¸€ä¸ªå­ç±»ã€‚æˆ‘ä»¬ä»¥å‰æ²¡æœ‰çœ‹åˆ°å®ƒçš„å †æ ˆè·Ÿè¸ªå°åœ¨æ§åˆ¶å°ã€‚è¿™æ˜¯å› ä¸ºåœ¨ä¸€ä¸ªè¢«å–æ¶ˆçš„å¾ªç¯ç¨‹åºé‡Œé¢<code>CancellationException</code>è¢«è®¤ä¸ºæ˜¯å¾ªç¯ç¨‹åºå®Œæˆçš„ä¸€ä¸ªæ­£å¸¸åŸå› ã€‚ç„¶è€Œï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åœ¨<code>main</code>å‡½æ•°ä¸­ä½¿ç”¨äº†`withTimeout'ã€‚</p>
<p>ç”±äºå–æ¶ˆåªæ˜¯ä¸€ä¸ªå¼‚å¸¸ï¼Œæ‰€æœ‰çš„èµ„æºéƒ½ä»¥æ­£å¸¸çš„æ–¹å¼å…³é—­ã€‚å¦‚æœä½ éœ€è¦åœ¨ä»»ä½•ä¸€ç§è¶…æ—¶æƒ…å†µä¸‹ä¸“é—¨åšä¸€äº›é¢å¤–çš„åŠ¨ä½œï¼Œä½ å¯ä»¥ç”¨<code>try {...} catch (e: TimeoutCancellationException) {...}</code>å—æ¥åŒ…è£…å¤„ç†è¶…æ—¶çš„ä»£ç ï¼Œæˆ–è€…ä½¿ç”¨<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/with-timeout-or-null.html">withTimeoutOrNull</a>å‡½æ•°ï¼Œå®ƒä¸<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/with-timeout.html">withTimeout</a>ç±»ä¼¼ï¼Œä½†åœ¨è¶…æ—¶åä¼šè¿”å›<code>null</code>è€Œä¸æ˜¯æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*

fun main() = runBlocking {
//sampleStart
    val result = withTimeoutOrNull(1300L) {
        repeat(1000) { i -&gt;
            println(&quot;I'm sleeping $i ...&quot;)
            delay(500L)
        }
        &quot;Done&quot; // will get cancelled before it produces this result
    }
    println(&quot;Result is $result&quot;)
//sampleEnd
}
</code></pre>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹:</p>
<pre><code class="language-text">I'm sleeping 0 ...
I'm sleeping 1 ...
I'm sleeping 2 ...
Result is null
</code></pre>
<h2 id="å¼‚æ­¥æ“ä½œçš„è¶…æ—¶å’Œèµ„æº">å¼‚æ­¥æ“ä½œçš„è¶…æ—¶å’Œèµ„æº</h2>
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/with-timeout.html">withTimeout</a>ä¸­çš„è¶…æ—¶äº‹ä»¶å¯¹äºåœ¨å…¶å—ä¸­è¿è¡Œçš„ä»£ç æ¥è¯´æ˜¯å¼‚æ­¥çš„ï¼Œå¯èƒ½åœ¨ä»»ä½•æ—¶å€™å‘ç”Ÿï¼Œç”šè‡³åœ¨ä»è¶…æ—¶ä»£ç å—å†…éƒ¨è¿”å›ä¹‹å‰ã€‚å¦‚æœä½ åœ¨åŒºå—å†…æ‰“å¼€æˆ–è·å–ä¸€äº›éœ€è¦åœ¨åŒºå—å¤–å…³é—­æˆ–é‡Šæ”¾çš„èµ„æºï¼Œè¯·ç‰¢è®°è¿™ä¸€ç‚¹ã€‚</p>
<p>ä¾‹å¦‚ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨<code>Resource</code>ç±»æ¥æ¨¡ä»¿ä¸€ä¸ªå¯å…³é—­çš„èµ„æºï¼Œå®ƒåªé€šè¿‡å¢åŠ <code>acquired</code>è®¡æ•°å™¨å’Œä»<code>close</code>å‡½æ•°ä¸­å‡å»è¿™ä¸ªè®¡æ•°å™¨æ¥è·Ÿè¸ªå®ƒè¢«åˆ›å»ºçš„æ¬¡æ•°ã€‚è®©æˆ‘ä»¬ç”¨å¾ˆå°çš„è¶…æ—¶æ¥è¿è¡Œå¤§é‡çš„å¾ªç¯ç¨‹åºï¼Œå°è¯•åœ¨å»¶è¿Ÿä¸€æ®µæ—¶é—´åä»<code>withTimeout</code>å—å†…éƒ¨è·å–è¿™ä¸ªèµ„æºï¼Œå¹¶ä»å¤–éƒ¨é‡Šæ”¾å®ƒã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*

//sampleStart
var acquired = 0

class Resource {
    init { acquired++ } // Acquire the resource
    fun close() { acquired-- } // Release the resource
}

fun main() {
    runBlocking {
        repeat(100_000) { // Launch 100K coroutines
            launch { 
                val resource = withTimeout(60) { // Timeout of 60 ms
                    delay(50) // Delay for 50 ms
                    Resource() // Acquire a resource and return it from withTimeout block     
                }
                resource.close() // Release the resource
            }
        }
    }
    // Outside of runBlocking all coroutines have completed
    println(acquired) // Print the number of resources still acquired
}
//sampleEnd
</code></pre>
<p>å¦‚æœä½ è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œä½ ä¼šå‘ç°å®ƒå¹¶ä¸æ€»æ˜¯æ‰“å°0ï¼Œå°½ç®¡è¿™å¯èƒ½å–å†³äºä½ çš„æœºå™¨çš„æ—¶é—´ï¼Œä½ å¯èƒ½éœ€è¦åœ¨è¿™ä¸ªä¾‹å­ä¸­è°ƒæ•´è¶…æ—¶æ—¶é—´ï¼Œä»¥çœŸæ­£çœ‹åˆ°é0å€¼ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼Œåœ¨è¿™é‡Œä»100K Coroutineä¸­å¢åŠ å’Œå‡å°‘<code>acquired</code>è®¡æ•°å™¨æ˜¯å®Œå…¨å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒæ€»æ˜¯å‘ç”Ÿåœ¨åŒä¸€ä¸ªä¸»çº¿ç¨‹ä¸­ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ç« çš„coroutineä¸Šä¸‹æ–‡ä¸­ä½œè¿›ä¸€æ­¥è§£é‡Šã€‚</p>
</blockquote>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½ å¯ä»¥åœ¨å˜é‡ä¸­å­˜å‚¨å¯¹èµ„æºçš„å¼•ç”¨ï¼Œè€Œä¸æ˜¯ä»<code>withTimeout</code> å—ä¸­è¿”å›å®ƒ</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*

var acquired = 0

class Resource {
    init { acquired++ } // Acquire the resource
    fun close() { acquired-- } // Release the resource
}

fun main() {
//sampleStart
    runBlocking {
        repeat(100_000) { // Launch 100K coroutines
            launch { 
                var resource: Resource? = null // Not acquired yet
                try {
                    withTimeout(60) { // Timeout of 60 ms
                        delay(50) // Delay for 50 ms
                        resource = Resource() // Store a resource to the variable if acquired      
                    }
                    // We can do something else with the resource here
                } finally {  
                    resource?.close() // Release the resource if it was acquired
                }
            }
        }
    }
    // Outside of runBlocking all coroutines have completed
    println(acquired) // Print the number of resources still acquired
//sampleEnd
}
</code></pre>
<p>è¿™ä¸ªä¾‹å­æ€»æ˜¯æ‰“å°å‡ºé›¶ã€‚èµ„æºä¸ä¼šæ³„æ¼ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ Kotlin Coroutine Part 1. Basic]]></title>
        <id>https://waltcow.github.io/post/ Kotlin Coroutine Part 1. Basic/</id>
        <link href="https://waltcow.github.io/post/ Kotlin Coroutine Part 1. Basic/">
        </link>
        <updated>2021-07-22T06:56:28.000Z</updated>
        <summary type="html"><![CDATA[<p>kotlinx.coroutines ä½œä¸ºä¸€ä¸ªç”±Jetbrainså¼€å‘çš„ Coroutine ç®¡ç†åº“ï¼Œå®ƒåŒ…å«äº†å¾ˆå¤šé«˜çº§çš„æ“ä½œcoroutinesçš„API, æœ¬æ–‡ä»‹ç»ä¸€äº›åŸºç¡€ç”¨æ³•ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>kotlinx.coroutines ä½œä¸ºä¸€ä¸ªç”±Jetbrainså¼€å‘çš„ Coroutine ç®¡ç†åº“ï¼Œå®ƒåŒ…å«äº†å¾ˆå¤šé«˜çº§çš„æ“ä½œcoroutinesçš„API, æœ¬æ–‡ä»‹ç»ä¸€äº›åŸºç¡€ç”¨æ³•ã€‚</p>
<!-- more -->
<h1 id="kotlin-coroutine">Kotlin Coroutine</h1>
<p>Kotlin è¯­è¨€ä¸­ <em>async</em> å’Œ <em>await</em> å¹¶ä¸æ˜¯ä¿ç•™çš„å…³é”®è¯ï¼Œ å®ƒåœ¨æ ‡å‡†åº“åªæä¾›äº†æœ‰é™çš„low-level çš„APIï¼Œè®©å…¶ç”Ÿæ€çš„åº“è‡ªå·±å»ç®¡ç†Coroutineç¼–ç¨‹æ§åˆ¶ç›¸å…³çš„ç»†èŠ‚ã€‚ å¦ä¸€æ–¹é¢ï¼Œç›¸å¯¹äºå…¶ä»–è¯­è¨€ä¸­çš„Futureå’ŒPromiseï¼ŒKotlinæå‡ºäº†Suspend çš„æ¦‚å¿µæŠ½è±¡è®©å¼‚æ­¥ç¼–ç¨‹å˜å¾—ç›¸å¯¹å®‰å…¨å’Œæ›´å°‘å‡ºé”™ã€‚</p>
<p><em>kotlinx.coroutines</em> ä½œä¸ºä¸€ä¸ªç”±Jetbrainså¼€å‘çš„ Coroutine ç®¡ç†åº“ï¼Œå®ƒåŒ…å«äº†å¾ˆå¤šé«˜çº§çš„æ“ä½œcoroutinesçš„APIï¼Œè­¬å¦‚ <em>launch</em> å’Œ <em>async</em> è¿˜æœ‰å…¶ä»–ã€‚</p>
<p>æ¥ä¸‹æ¥é˜è¿°coroutineçš„åŸºæœ¬æ¦‚å¿µ</p>
<p>Coroutine æ˜¯å¯suspendè®¡ç®—çš„å®ä¾‹, æ¦‚å¿µä¸Šå®ƒå’Œçº¿ç¨‹éå¸¸çš„ç›¸ä¼¼ï¼Œå®ƒä»¬éƒ½ä¼šæ¥æ”¶ä¸€æ®µå—çŠ¶ä»£ç ï¼Œå¹¶ä¸å‰©ä¸‹çš„ä»£ç åŒæ—¶æ‰§è¡Œ</p>
<p>ä½†å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œcoroutine æ˜¯ä¸å’Œä»»ä½•ç‰¹å®šçš„çº¿ç¨‹ç»‘å®šåœ¨ä¸€èµ·çš„ï¼Œå®ƒå¯èƒ½ä¼šåœ¨ä¸€æ¡çº¿ç¨‹ä¸Šæ‰§è¡Œçš„ï¼Œè€Œåœ¨å¦å¤–ä¸€æ¡ä¸Šæ¢å¤ã€‚</p>
<p>Coroutines å¯ä»¥è¢«æƒ³è±¡ä¸ºè½»é‡åŒ–çš„çº¿ç¨‹ï¼Œä½†å®ƒä»¬ä¹‹é—´æœ‰ç€é‡è¦çš„åŒºåˆ«ï¼Œä»¥è‡³äºåœ¨çœŸå®çš„ä½¿ç”¨åœºæ™¯ä¸­å’Œçº¿ç¨‹æœ‰ç€æ˜æ˜¾çš„ä¸åŒ</p>
<p>ä¸‹é¢ä»£ç ä½œä¸ºé¦–ä¸ªcoroutineçš„ä¾‹å­ä½œä¸ºé˜è¿°</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*

//sampleStart
fun main() = runBlocking { // this: CoroutineScope
    launch { // launch a new coroutine and continue
        delay(1000L) // non-blocking delay for 1 second (default time unit is ms)
        println(&quot;World!&quot;) // print after delay
    }
    println(&quot;Hello&quot;) // main coroutine continues while a previous one is delayed
}
//sampleEnd
</code></pre>
<p>æ‰“å°çš„ç»“æœ</p>
<pre><code>Hello
World!
</code></pre>
<p>ä¸‹é¢é€è¡Œåˆ†æä»£ç çš„æ‰§è¡Œè¿‡ç¨‹</p>
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/launch.html">launch</a>  æ˜¯ coroutineæ„é€ å™¨. å®ƒå¦å¼€äº†æ–°çš„åç¨‹ï¼ŒåŒæ—¶æ‰§è¡Œå‰©ä¸‹çš„ä»£ç ï¼Œè¿™éƒ½æ˜¯åŒæ—¶ç‹¬ç«‹çš„æ‰§è¡Œï¼Œæ‰€ä»¥ <strong>Hello</strong> ä¼šç¬¬ä¸€ä¸ªè¢«æ‰“å°å‡ºæ¥</p>
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/delay.html">delay</a>  æ˜¯ä¸€ä¸ªç‰¹æ®Š <em>suspending function</em>. å®ƒä¼šåœ¨coroutineä¸Š <em>suspends</em> ä¸€æ®µæ—¶é—´ã€‚ coroutineåœ¨æš‚åœçš„åŒæ—¶å¹¶ä¸ä¼šå¯¹é˜»å¡å®ƒæ‰€å¤„åœ¨çš„çº¿ç¨‹ ï¼ŒåŒæ—¶å…è®¸å…¶ä»–çš„coroutine åœ¨å®ƒå½“å‰çš„çº¿ç¨‹ä¸­æ‰§è¡Œå®ƒä»¬çš„ä»£ç ã€‚</p>
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/run-blocking.html">runBlocking</a>  å¦ä¸€ä¸ª coroutineçš„æ„é€ å™¨ï¼Œå®ƒå¯ä»¥è®©åç¨‹çš„ä»£ç å’Œå¤–ç•Œæœ‰äº†æ¡¥æ¥å’Œè”ç³»ï¼Œä»¥main() ä½œä¸ºå…¥å£ã€‚åœ¨ä¸€ç³»åˆ—çš„coroutineå¤–é¢ä¼šè¢«runBlocking ç”¨ { â€¦ }   åŒ…ç€ï¼Œåœ¨IDE ä¸‹é¢ä¼šæœ‰é«˜äº®çš„æç¤º  ::CoroutineScope hint right after the runBlocking opening curly brace:: å½“ä½ åœ¨ä½ ä»£ç ä¸­ç”¨ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/launch.html">launch</a> å‘èµ·äº†è°ƒç”¨ï¼Œå´å¿˜è®°ç”¨ runBlockingåŒ…è£¹æ—¶å°†ä¼šå‡ºç°æŠ¥é”™ï¼Œå› ä¸º launch åªèƒ½åœ¨   <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-scope/index.html">CoroutineScope</a> ä¸­å£°æ˜ã€‚</p>
<p><strong>runBlocking</strong> æ„å‘³ç€å¤„åœ¨è¿™ä¸€çº¿ç¨‹ä¸­çš„ï¼ˆä¸Šé¢ä¾‹å­ä¸ºä¸»çº¿ç¨‹ï¼‰ä»£ç åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å°†ä¼šè¢« <strong>blocked</strong>ï¼Œç›´åˆ°runBlocking { â€¦ } æ‰€æœ‰çš„coroutines å®Œæˆæ‰€æœ‰çš„æ‰§è¡Œã€‚ä½ ä¼šç»å¸¸çœ‹åˆ°runBlocking ç”¨åœ¨ç¨‹åºä¸­éå¸¸é å‰çš„ä½ç½®ï¼Œå¹¶ä¸”å¾ˆå°‘ä¼šåœ¨çœŸå®çš„ä¸šåŠ¡ä»£ç ä¸­çœ‹åˆ°ã€‚è¿™æ˜¯å› ä¸ºçº¿ç¨‹æ˜¯éå¸¸æ˜‚è´µçš„èµ„æºï¼Œé˜»å¡å®ƒä»¬æ˜¯å¾ˆä½æ•ˆä¸”å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚</p>
<p>ç»“æ„åŒ–çš„å¹¶å‘ç¼–ç¨‹</p>
<p>Coroutines éµå¾ªç€ <strong>ç»“æ„åŒ–å¹¶å‘çš„</strong> çš„åŸåˆ™ï¼Œè¿™æ„å‘³ç€æ–°çš„coroutines åªèƒ½è¢«ç‰¹å®šçš„<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-scope/index.html">CoroutineScope</a> å‘èµ·ï¼Œå®ƒç•Œå®šäº†coroutinesçš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p>ä¸Šé¢çš„ä¾‹å­ä»‹ç»äº† <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/run-blocking.html">runBlocking</a> çš„ä½¿ç”¨ï¼Œå®ƒåˆ›å»ºäº†ç›¸å…³çš„ä½œç”¨åŸŸï¼Œå› æ­¤å‰ä¸€ä¸ªä¾‹å­ä¸­ä¸€ç›´ç­‰åˆ° å»¶è¿Ÿä¸€ç§’å world çš„è¾“å‡º æ‰ç»“æŸã€‚</p>
<p>åœ¨çœŸå®çš„åº”ç”¨ä¸­ã€‚æˆ‘ä»¬å¯èƒ½å¯åŠ¨å¤šä¸ªåç¨‹ã€‚ ç»“æ„åŒ–çš„åŒæ­¥ç¡®ä¿äº†å®ƒä»¬ä¸ä¼šä¸¢å¤±å’Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚å¤–éƒ¨çš„ä½œç”¨åŸŸä¼šç­‰åˆ°å®ƒå†…éƒ¨çš„å­åç¨‹ç»“æŸæ‰é€€å‡ºã€‚</p>
<p>ç»“æ„åŒ–çš„åŒæ­¥ä¹Ÿç¡®ä¿äº†ä»£ç ä¸­çš„æ‰€æœ‰é”™è¯¯éƒ½èƒ½æ­£ç¡®åœ°è¢«æ”¶é›†ä¸‹æ¥å¹¶ä¸ä¼šä¸¢å¤±ã€‚</p>
<h3 id="æå–å‡½æ•°å¹¶é‡æ„">æå–å‡½æ•°å¹¶é‡æ„</h3>
<p>è®©æˆ‘ä»¬æŠŠ launch{ ... } ä¸­çš„ä»£ç å—æå–åˆ°ä¸€ä¸ªå•ç‹¬çš„å‡½æ•°ä¸­ã€‚å½“ä½ å¯¹è¿™æ®µä»£ç è¿›è¡Œ &quot;æå–å‡½æ•° &quot;é‡æ„æ—¶ï¼Œä½ å°†å£°æ˜ä¸€ä¸ªå¸¦æœ‰suspendä¿®æ”¹å™¨çš„æ–°å‡½æ•°ã€‚è¿™æ˜¯ä½ çš„ç¬¬ä¸€ä¸ªsuspendå‡½æ•°ã€‚suspendå‡½æ•°å¯ä»¥åƒæ™®é€šå‡½æ•°ä¸€æ ·åœ¨ coroutine ä¸­ä½¿ç”¨ï¼Œä½†å®ƒä»¬çš„æœ‰ç€suspendç‰¹æ€§ï¼Œå®ƒä»¬å¯ä»¥åè¿‡æ¥ä½¿ç”¨å…¶ä»–suspendçš„å‡½æ•°ï¼ˆå¦‚æœ¬ä¾‹ä¸­çš„ delayï¼‰æ¥æŒ‚èµ· coroutine çš„æ‰§è¡Œã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*

//sampleStart
fun main() = runBlocking { // this: CoroutineScope
    launch { doWorld() }
    println(â€œHelloâ€)
}

// this is your first suspending function
suspend fun doWorld() {
    delay(1000L)
    println(â€œWorld!â€)
}
//sampleEnd
</code></pre>
<h3 id="ä½œç”¨åŸŸçš„æ„é€ å™¨">ä½œç”¨åŸŸçš„æ„é€ å™¨</h3>
<p>é™¤äº†è‡ªå¸¦ä¸­çš„ä¸åŒæ„å»ºå™¨æ‰€æä¾›scopeä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/coroutine-scope.html">coroutineScope</a> æ„å»ºå™¨æ¥å£°æ˜è‡ªå®šä¹‰çš„scopeã€‚å®ƒåˆ›å»ºä¸€ä¸ªcoroutine scopeï¼Œåœ¨æ‰€æœ‰å¯åŠ¨çš„å­ç¨‹åºå®Œæˆä¹‹åæ‰ä¼šè¢«é”€æ¯ã€‚</p>
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/run-blocking.html">runBlocking</a> å’Œ <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/coroutine-scope.html">coroutineScope</a> æ„å»ºå™¨çœ‹èµ·æ¥å¾ˆç›¸ä¼¼ï¼Œå› ä¸ºå®ƒä»¬éƒ½åœ¨ç­‰å¾…å…¶ä¸»ä½“å’Œæ‰€æœ‰å­ç¨‹åºå®Œæˆã€‚ä¸»è¦çš„åŒºåˆ«åœ¨äº <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/run-blocking.html">runBlocking</a>æ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹å¹¶è¿›è¡Œç­‰å¾…ï¼Œè€Œ<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/coroutine-scope.html">coroutineScope</a>åªæ˜¯æš‚åœï¼Œé‡Šæ”¾åº•å±‚çº¿ç¨‹ç”¨äºå…¶ä»–ç”¨é€”ã€‚å› ä¸ºè¿™ä¸ªåŒºåˆ«ï¼Œ<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/run-blocking.html">runBlocking</a>æ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œè€Œ<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/coroutine-scope.html">coroutineScope</a>æ˜¯ä¸€ä¸ªæš‚åœçš„å‡½æ•°ã€‚</p>
<p>ä½ å¯ä»¥ä»ä»»ä½•ä¸€ä¸ªsuspendå‡½æ•°ä¸­ä½¿ç”¨coroutineScopeã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥å°†Helloå’ŒWorldçš„å¹¶å‘æ‰“å°è½¬ç§»åˆ°ä¸€ä¸ªsuspendçš„å‡½æ•°doWorld()ä¸­ã€‚</p>
<pre><code class="language-kotlin">
import kotlinx.coroutines.*

//sampleStart
fun main() = runBlocking {
    doWorld()
}

suspend fun doWorld() = coroutineScope {  // this: CoroutineScope
    launch {
        delay(1000L)
        println(â€œWorld!â€)
    }
    println(â€œHelloâ€)
}
//sampleEnd
</code></pre>
<p>ä»£ç è¾“å‡ºç»“æœ</p>
<pre><code>Hello
World!
</code></pre>
<h3 id="ä½œç”¨åŸŸæ„é€ å™¨å’Œå¹¶å‘">ä½œç”¨åŸŸæ„é€ å™¨å’Œå¹¶å‘</h3>
<p>ä¸€ä¸ª<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/coroutine-scope.html">coroutineScope</a>æ„å»ºå™¨å¯ä»¥ç”¨åœ¨ä»»ä½•suspendå‡½æ•°ä¸­ï¼Œä»¥æ‰§è¡Œå¤šä¸ªå¹¶å‘çš„æ“ä½œã€‚è®©æˆ‘ä»¬åœ¨ä¸€ä¸ªdoWorld çš„suspendå‡½æ•°ä¸­å¯åŠ¨ä¸¤ä¸ªå¹¶å‘çš„coroutineã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*

//sampleStart
// Sequentially executes doWorld followed by â€œDoneâ€
fun main() = runBlocking {
    doWorld()
    println(â€œDoneâ€)
}

// Concurrently executes both sections
suspend fun doWorld() = coroutineScope { // this: CoroutineScope
    launch {
        delay(2000L)
        println(â€œWorld 2â€)
    }
    launch {
        delay(1000L)
        println(â€œWorld 1â€)
    }
    println(â€œHelloâ€)
}
//sampleEnd
</code></pre>
<p>launch { ... }å—å†…çš„ä¸¤æ®µä»£ç éƒ½æ˜¯åŒæ—¶æ‰§è¡Œçš„ï¼Œä»å¼€å§‹çš„ä¸€ç§’é’Ÿåï¼Œå…ˆæ‰“å°<em>World 1</em>ï¼Œä»å¼€å§‹çš„ä¸¤ç§’é’Ÿåï¼Œæ¥ç€æ‰“å° <em>World 2</em>ã€‚doWorld ä¸­çš„<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/coroutine-scope.html">coroutineScope</a>åªæœ‰åœ¨è¿™ä¸¤æ®µä»£ç å®Œæˆåæ‰ä¼šå®Œæˆï¼Œæ‰€ä»¥doWorldè¿”å›å¹¶åœ¨è¿™ä¹‹åæ‰“å° <em>Done</em>ã€‚</p>
<h3 id="æ˜¾å¼çš„job">æ˜¾å¼çš„Job</h3>
<p>ä¸€ä¸ª <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/launch.html">launch</a> coroutine builder ä¼šè¿”å›ä¸€ä¸ª <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-job/index.html">Job</a> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ˜¯å¯åŠ¨çš„ coroutine çš„å¥æŸ„ï¼Œå¯ä»¥ç”¨æ¥æ˜ç¡®åœ°ç­‰å¾…å…¶å®Œæˆã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ç­‰å¾…å­å¾ªç¯ç¨‹åºçš„å®Œæˆï¼Œç„¶åæ‰“å° <em>Done</em> ã€‚</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*

fun main() = runBlocking {
//sampleStart
    val job = launch { // launch a new coroutine and keep a reference to its Job
        delay(1000L)
        println(â€œWorld!â€)
    }
    println(â€œHelloâ€)
    job.join() // wait until child coroutine completes
    println(â€œDoneâ€) 
//sampleEnd    
}
</code></pre>
<p>ä»£ç è¾“å‡ºç»“æœ</p>
<pre><code>Hello
World!
Done
</code></pre>
<h3 id="ç›¸å½“è½»é‡åŒ–çš„coroutines">ç›¸å½“è½»é‡åŒ–çš„Coroutines</h3>
<p>æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š</p>
<pre><code class="language-kotlin">import kotlinx.coroutines.*

//sampleStart
fun main() = runBlocking {
    repeat(100_000) { // launch a lot of coroutines
        launch {
            delay(5000L)
            print(â€œ.â€)
        }
    }
}
//sampleEnd
</code></pre>
<p>å®ƒå¯åŠ¨äº†100Kä¸ªcoroutinesï¼Œ5ç§’é’Ÿåï¼Œæ¯ä¸ªcoroutineæ‰“å°ä¸€ä¸ªç‚¹ã€‚</p>
<p>ç°åœ¨ï¼Œç”¨çº¿ç¨‹è¯•è¯•ï¼ˆå»æ‰<em>runBlocking</em>ï¼Œç”¨çº¿ç¨‹ä»£æ›¿åç¨‹å¯åŠ¨ï¼Œç”¨ <em>Thread.sleep</em>ä»£æ›¿å»¶è¿Ÿï¼‰ã€‚ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ(å¾ˆå¯èƒ½ä½ çš„ä»£ç ä¼šäº§ç”Ÿå†…å­˜ä¸è¶³çš„é”™è¯¯)</p>
<h3 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h3>
<p><a href="https://kotlinlang.org/docs/coroutines-basics.html#your-first-coroutine">Coroutines basics</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å…³äº]]></title>
        <id>https://waltcow.github.io/post/about/</id>
        <link href="https://waltcow.github.io/post/about/">
        </link>
        <updated>2019-01-25T11:09:48.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>æ¬¢è¿æ¥åˆ°æˆ‘çš„å°ç«™å‘€ï¼Œå¾ˆé«˜å…´é‡è§ä½ ï¼ğŸ¤</p>
</blockquote>
<h2 id="å…³äºæœ¬ç«™">ğŸ  å…³äºæœ¬ç«™</h2>
<p>ä¸€äº›codingçš„ç¢ç¢å¿µ</p>
<h2 id="å…´è¶£çˆ±å¥½">â›¹ å…´è¶£çˆ±å¥½</h2>
<p>ç¼–ç¨‹ï¼Œç”µå½±ï¼Œå°è¯•å†™ç‚¹ä¸œè¥¿</p>
<h2 id="è”ç³»æˆ‘å‘€">ğŸ“¬ è”ç³»æˆ‘å‘€</h2>
<p><a href="mailto:waltcow@gmail.com">Email</a></p>
<p><a href="https://github.com/waltcow">Github</a></p>
]]></content>
    </entry>
</feed>